function getUserLanguage(t){for(var e=(window.navigator.languages||[window.navigator.language||window.navigator.userLanguage]).map(function(t){return t.substring(0,2).toLowerCase()}).filter(function(t,e,a){return a.indexOf(t)===e}),a=0;a<e.length;a++)if(-1!=t.indexOf(e[a]))return e[a];return t[0]}function loadData(){var t=$(".badges"),e=new Date;if($(".fa.fa-refresh").addClass("fa-spin"),!t.children().length){var a=$($("#badge-template").html());$(config.badges).each(function(e,n){var i=a.clone();$(".channel-icon",i).addClass("fa-"+n.icon),i.prop("id","badge-"+e).appendTo(t)}),$("body").css({opacity:1})}if($(config.badges).each(function(t,a){var n=APIUrl,i={attributes:!0};-1!=["sunrise","sunset"].indexOf(a.guid)?i.format="H:i":n+="data/last/",$.ajax({url:n+a.guid,jsonp:"callback",dataType:"jsonp",data:i,success:function(n){var i=n.shift(),r=i18n._(i.name,!0),o="#badge-"+t;if(i.description&&(r+=" ("+i.description+")"),$(".channel-name",o).html(r),$(".channel-unit",o).html(i.unit),n.length){var l=new Date(1e3*n[0].timestamp),s=i.numeric?n[0].data.toFixed(null!=a.decimals?a.decimals:i.decimals):n[0].data;0===i.meter&&l.getTime()+6e5<e.getTime()&&(s="-"),"-0"==s&&(s="0"),$(".last-value",o).html(s),$(".panel-footer .pull-left",o).html(l.toLocaleDateString()),$(".panel-footer .pull-right",o).html(l.toLocaleTimeString())}else $(".last-value, .panel-footer .pull-left, .panel-footer .pull-right",o).html("?")}})}),config.power&&($(".chart-wrapper.power").show(),$.when($.getJSON(APIUrl+"data/"+config.power+"?callback=?",{attributes:!0,period:"5i","short":!0}),$.getJSON(APIUrl+"sunrise?callback=?",{"short":!0}),$.getJSON(APIUrl+"sunset?callback=?",{"short":!0})).done(function(t,e,a){t=t[0],e=e[0],a=a[0];var n=t.shift(),r=[];for(i=0;i<t.length;i++)r.push([1e3*t[i][0],t[i][1]]);var o=$("<div/>").html(n.name).text(),l=$.extend(chartOptions,{chart:{spacingLeft:5,spacingRight:5},title:{text:o},tooltip:{valueSuffix:" "+n.unit,xDateFormat:"%H:%M"},yAxis:{title:{text:n.unit}},series:[{color:"#F81",name:"Sunrise",type:"scatter",marker:{symbol:"url(/img/sunrise.png)"},tooltip:{pointFormat:"<br/>"},data:[[1e3*e[0][0],0]]},{color:"#F81",name:"Sunset",type:"scatter",marker:{symbol:"url(/img/sunset.png)"},tooltip:{pointFormat:"<br/>"},data:[[1e3*a[0][0],0]]},{color:color_act,name:o,marker:{enabled:!1},type:"areaspline",data:r}]});drawChart("day-chart",l)})),config.energy){$(".chart-wrapper.energy").show(),$.getJSON(APIUrl+"data/"+config.energy+"?callback=?",{attributes:!0,period:"1d",start:-30,"short":!0},function(t){var a=t.shift(),n=[],r=0;for(i=0;i<t.length;i++)n.push([1e3*t[i][0],+(t[i][1]-r).toFixed(a.decimals)]),r=t[i][1];var o=e.getMonth(),l=e.getDate()>15?o+1:o-1;0>l?l=11:l>11&&(l=0);var s=$.extend(chartOptions,{tooltip:{valueSuffix:" "+a.unit,xDateFormat:"%Y-%m-%d"},yAxis:{plotBands:[{color:color_est,from:0,to:(config.estimate[o]+config.estimate[l])/2/30}],title:{text:a.unit}}});s.series=[{color:color_act,name:$("<div/>").html(a.name).text(),type:"column",data:n.slice(-7)}],drawChart("week-chart",s),s.series[0].data=n,drawChart("month-chart",s)});var n=new Date((new Date).getFullYear(),0,1);$.getJSON(APIUrl+"data/"+config.energy+"?callback=?",{attributes:!0,period:"7d",full:!0,start:n.getTime()/1e3},function(t){var e,a=t.shift(),n=[],r=[],o=new Date;for(i=0;i<t.length;i++)n.push([1e3*t[i].timestamp,Math.round(t[i].consumption,0)]),o=new Date(1e3*t[i].timestamp),(o.getMonth()!=e||i==t.length-1)&&(r.push([1e3*t[i].timestamp,+(config.estimate[o.getMonth()]/30.4*7).toFixed(0)]),e=o.getMonth());for(var l=new Date((new Date).getFullYear()+1,0,1);l>o;)o=new Date(o.getTime()+6048e5),(o.getMonth()!=e||i==t.length-1)&&(r.push([o.getTime(),+(config.estimate[o.getMonth()]/30.4*7).toFixed(0)]),e=o.getMonth());r.pop();var s=[{color:color_act,name:$("<div/>").html(a.name).text(),type:"column",data:n}];config.estimate.reduce(function(t,e){return t+e},0)&&s.push({color:color_est,name:i18n._("estimate"),marker:{enabled:!1},type:"spline",data:r}),drawChart("year-chart",$.extend(chartOptions,{tooltip:{shared:!0,valueSuffix:" "+a.unit,xDateFormat:"%Y-%m-%d"},yAxis:{title:{text:a.unit}},series:s}))})}setTimeout(function(){$(".fa.fa-refresh").removeClass("fa-spin")},3e3)}function drawChart(t,e){e.chart.height=9*$("#"+t).width()/16,Highcharts.chart(t,e)}function resizeChart(t){w=t.width(),t.highcharts().setSize(w,9*w/16,!0)}function translate(t){var e=t;this._=function(t,a){return e[t]?e[t]:a?t:"{{"+t+"}}"}}var APIUrl="//"+config.host+"/api/latest/",languages=["en","de"],colors=["#7cb5ec","#434348","#90ed7d","#f7a35c","#8085e9","#f15c80","#e4d354","#2b908f","#f45b5b","#91e8e1"],color_act=colors[0],color_est=colors[2],chartOptions={chart:{spacingLeft:0,spacingTop:5,spacingRight:0,spacingBottom:0},credits:{enabled:!1},legend:{enabled:!1},xAxis:{type:"datetime"}},i18n;$(function(){Highcharts.setOptions({global:{useUTC:!1}}),$(window).on("resize",function(){$(".highcharts-container").each(function(t,e){resizeChart($(e).parent())})}),$.when($.getJSON(APIUrl+"settings/title?callback=?"),$.getJSON(APIUrl+"translate/"+getUserLanguage(languages)+"/dashboard?callback=?")).done(function(t,e){$("span",".page-header").html(t[0]),document.title=$(".page-header").text(),i18n=new translate(e[0]),$(".i18n").each(function(t,e){e=$(e),e.html(i18n._(e.data("i18n")))}),loadData()})});